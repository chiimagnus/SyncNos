# IAP 调试指南

## 概述

IAP 调试面板为开发者提供了在开发过程中测试和调试应用内购买功能的工具。此功能**仅在开发环境中可用**，在生产构建中会自动禁用。

## 访问调试面板

1. 在 Xcode 中运行应用或使用 StoreKit 配置文件
2. 打开设置 (⌘,)
3. 导航至**支持本计划**区域
4. 点击 **IAP 调试**（仅在开发模式下可见）

## 功能特性

### 环境检测

调试面板自动检测您是否在以下环境中运行：
- **开发环境**：Xcode、StoreKit 配置文件或沙盒环境
- **生产环境**：TestFlight 或 App Store 构建

### 购买状态显示

查看当前 IAP 状态，包括：
- 年度订阅状态
- 永久许可证状态
- 试用期状态和剩余天数
- 首次启动日期
- 设备指纹
- 所有与 IAP 相关的 UserDefaults 和 Keychain 数据

### 重置所有 IAP 数据

**⚠️ 警告**：此操作无法撤销。

清除所有购买和试用数据：
- UserDefaults 购买标记
- Keychain 试用期数据
- 设备指纹
- 试用提醒时间戳

重置后，应用将表现得像是全新安装，带有新的 30 天试用期。

### 模拟购买状态

无需实际购买即可测试不同场景：

**购买状态：**
- 已购买年度订阅
- 已购买永久许可证

**试用状态：**
- 试用第 1、7、15、29 天
- 试用已过期（31+ 天）

## 使用示例

### 测试购买流程

1. 重置所有 IAP 数据
2. 导航至购买页面
3. 测试完整购买流程
4. 验证 UI 正确更新

### 测试试用过期

1. 模拟"试用第 29 天"
2. 验证试用提醒出现
3. 模拟"试用已过期"
4. 验证付费墙出现

### 测试恢复购买

1. 模拟已购买状态
2. 重置所有 IAP 数据
3. 测试恢复购买功能
4. 验证购买状态已恢复

## 技术详情

### 环境检测逻辑

系统检查：
1. `#if DEBUG` 编译标记
2. StoreKit 配置文件使用情况
3. App Store 收据位置和类型

### 数据存储

IAP 数据存储在：
- **UserDefaults**：购买标记、试用日期、提醒时间戳
- **Keychain**：首次启动日期、设备指纹（更持久）

### 日志记录

所有调试操作都会记录日志，包含：
- 操作前状态
- 操作的每个步骤
- 操作后状态
- 遇到的任何错误

在日志窗口中查看日志（可从菜单栏访问）。

## 安全特性

### 生产环境保护

所有调试功能在执行前都会检查环境：
```swift
guard DIContainer.shared.environmentDetector.isDevEnvironment() else {
    throw IAPError.productionEnvironmentResetNotAllowed
}
```

### 确认对话框

重置操作需要明确确认，以防止意外数据丢失。

### 全面日志记录

所有操作都会被记录用于调试和审计目的。

## 故障排除

### 调试面板不可见

- 确保您在 Xcode 中运行或使用 StoreKit 配置文件
- 检查构建设置中是否启用了 `#if DEBUG`
- 验证应用不是生产构建

### 重置不工作

- 检查日志窗口中的错误消息
- 确保您在开发环境中
- 尝试重置后重启应用

### 模拟状态不持久

- 某些状态需要应用重启才能完全生效
- 检查 UserDefaults 和 Keychain 部分以验证数据已写入
- 查看日志以了解模拟过程中的任何错误

## 最佳实践

1. **测试购买流程前始终重置** - 确保状态干净
2. **测试所有试用天场景** - 验证不同试用阶段的 UI
3. **测试过期状态** - 确保付费墙正确显示
4. **操作后检查日志** - 验证操作成功完成
5. **测试恢复购买** - 确保用户可以恢复购买

## 相关文件

- `Services/Core/EnvironmentDetector.swift` - 环境检测
- `Services/Auth/IAPService.swift` - 带调试扩展的 IAP 服务
- `ViewModels/Account/IAPDebugViewModel.swift` - 调试面板视图模型
- `Views/Setting/IAPViews/IAPDebugView.swift` - 调试面板 UI
- `Models/IAPDebugModels.swift` - 调试数据模型
