# 加密数据解密失败故障排除指南

## 问题概述

如果您在使用聊天功能时看到 `[解密失败]` 或 `[解密失败：密钥不匹配]` 的文本，这表示本地加密数据无法被解密。本文档将帮助您理解问题原因并提供解决方案。

## 加密机制说明

### 为什么需要加密？

SyncNos 的聊天功能会将以下敏感信息加密存储在本地数据库中：
- 对话名称
- 消息内容
- 发送者昵称

这样做是为了保护您的隐私，即使他人获得了您的设备访问权限或数据库文件，也无法直接读取这些敏感信息。

### 加密技术细节

- **算法**：AES-256-GCM（美国国家标准技术研究所 NIST 推荐）
- **密钥管理**：密钥存储在 macOS Keychain 中
- **访问权限**：仅在设备解锁时可访问（`kSecAttrAccessibleWhenUnlocked`）
- **同步**：密钥不会同步到 iCloud（`kSecAttrSynchronizable = false`）

### Keychain 存储位置

- **服务标识**：`com.syncnos.encryption`
- **账户名称**：`chats.aes.key`

## 常见问题和原因

### 1. 密钥丢失

**症状**：所有对话名称和消息显示 `[解密失败：密钥不匹配]`

**可能原因**：
- Keychain 被清空或重置
- 系统恢复或迁移时 Keychain 数据未正确迁移
- 手动删除了 Keychain 条目
- macOS 用户账户变更

**影响**：无法恢复已加密的数据（除非能找回原密钥）

### 2. Keychain 访问权限问题

**症状**：间歇性出现解密失败，重启应用后可能恢复

**可能原因**：
- 系统锁定状态下尝试访问（密钥设置为 `WhenUnlocked`）
- Keychain 服务暂时不可用
- 权限配置错误

**影响**：临时性问题，通常在设备解锁后自动恢复

### 3. 数据库文件损坏

**症状**：部分消息显示 `[解密失败]`，其他正常

**可能原因**：
- 数据库文件损坏
- 加密数据的格式不正确
- 应用异常退出导致数据写入不完整

**影响**：受影响的数据无法恢复

## 诊断工具

### 使用内置健康检查（DEBUG 模式）

1. 在聊天列表底部找到"调试工具"区域
2. 点击"检查加密健康状态"按钮
3. 查看报告内容：

```
=== 加密服务健康检查 ===
✅ 加密服务可用
🔑 密钥指纹: a1b2c3d4e5f6g7h8
✅ 加密/解密测试通过

=== 数据库解密状态 ===
成功: 5 个对话
失败: 0 个对话
```

### 报告解读

- **加密服务可用**：EncryptionService 可以正常工作
- **密钥指纹**：当前使用密钥的唯一标识（SHA256 哈希前16位）
- **加密/解密测试**：使用当前密钥进行加密解密测试
- **数据库解密状态**：统计实际数据的解密成功/失败数量

### 日志检查

在应用日志中查找以下关键信息：

```
[Encryption] 从 Keychain 加载密钥成功
[Encryption] 密钥验证成功 - 加密服务正常
```

或者错误信息：

```
[Encryption] Keychain 中未找到密钥，生成新密钥（这将导致已加密的数据无法解密）
[Encryption] AES-GCM 解密失败 - 可能是密钥不匹配或数据损坏
```

## 解决方案

### 情况 1：密钥完全丢失（所有数据解密失败）

**重要提示**：此操作将永久删除所有聊天数据。

1. 在 DEBUG 模式下，点击健康检查弹窗中的"重置加密和数据"按钮
2. 确认操作
3. 应用将：
   - 删除所有聊天数据
   - 删除旧密钥
   - 生成新密钥
4. 重新开始导入聊天截图

### 情况 2：部分数据解密失败

**方案 A：导出-清理-重新导入**

1. 使用导出功能导出可正常解密的对话（JSON 或 Markdown 格式）
2. 执行"重置加密和数据"
3. 重新导入导出的数据

**方案 B：手动清理受影响的对话**

1. 在聊天列表中右键点击受影响的对话
2. 选择"删除"
3. 重新导入该对话的截图

### 情况 3：Keychain 访问权限问题

1. 确保设备已解锁
2. 重启应用
3. 如果问题持续，检查系统设置中的 Keychain 权限

## 预防措施

### 1. 定期备份

- 使用导出功能定期备份重要对话
- 导出格式（JSON/Markdown）不加密，可以在任何设备上查看

### 2. 避免直接操作 Keychain

- 不要手动删除 `com.syncnos.encryption` 相关的 Keychain 条目
- 系统迁移时确保 Keychain 数据被正确迁移

### 3. 监控日志

- 定期检查应用日志中的加密相关警告
- 发现问题及时处理，避免数据累积后无法恢复

## 技术支持

如果您遇到无法通过本指南解决的问题，请提供以下信息：

1. 健康检查报告的完整内容
2. 应用日志中与 `[Encryption]` 相关的所有条目
3. 问题出现的时间和触发条件
4. macOS 版本和应用版本

## 安全性说明

根据 Kerckhoffs 原则，加密算法的公开不会降低安全性。SyncNos 的加密安全性完全依赖于：

1. **密钥的保密性**：密钥存储在 Keychain 中，受 macOS 登录密码保护
2. **算法的强度**：AES-256-GCM 是经过验证的军用级加密标准
3. **实现的正确性**：使用 Apple CryptoKit 的标准实现

**重要提示**：如果密钥丢失，即使是应用开发者也无法恢复您的加密数据。这是设计特性，而非缺陷。

## 附录：手动检查 Keychain

您可以使用 macOS 自带的"钥匙串访问"应用手动检查密钥：

1. 打开"钥匙串访问"应用（位于 `/Applications/Utilities/`）
2. 在搜索框中输入 `com.syncnos.encryption`
3. 查找名为 `chats.aes.key` 的条目
4. 双击查看详细信息（但无法查看密钥本身）

如果找不到此条目，说明密钥已丢失。
