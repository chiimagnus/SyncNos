---
description: 当进行i18n本地化工作时读取这个cursor rule
alwaysApply: false
---
# 国际化翻译流程指南 (i18n Translation Guide)

本文档详细说明如何为 SyncNos 项目的 `Localizable.xcstrings` 文件添加多语言翻译。

## 支持的语言 (16种)

| 语言代码 | 语言名称 |
|---------|---------|
| `en` | English |
| `zh-Hans` | Chinese, Simplified (简体中文) |
| `da` | Danish (丹麦语) |
| `nl` | Dutch (荷兰语) |
| `fi` | Finnish (芬兰语) |
| `fr` | French (法语) |
| `de` | German (德语) |
| `id` | Indonesian (印尼语) |
| `ja` | Japanese (日语) |
| `ko` | Korean (韩语) |
| `pt-BR` | Portuguese, Brazil (巴西葡萄牙语) |
| `ru` | Russian (俄语) |
| `es` | Spanish, Spain (西班牙语) |
| `sv` | Swedish (瑞典语) |
| `th` | Thai (泰语) |
| `vi` | Vietnamese (越南语) |

## 翻译流程

### 步骤 1：搜索字符串位置

使用 `grep` 在 `Localizable.xcstrings` 文件中搜索目标字符串：

```bash
grep -n '"目标字符串"' /path/to/Resource/Localizable.xcstrings
```

**示例：**
```bash
grep -n '"Connect Your Notion"' /Users/chii_magnus/Github_OpenSource/SyncNos/Resource/Localizable.xcstrings
```

**输出：**
```
4572:    "Connect Your Notion" : {
```

### 步骤 2：查看字符串上下文和 comment

使用 `sed` 查看字符串周围的内容，特别是 `comment` 字段：

```bash
sed -n '行号,行号+20p' /path/to/Resource/Localizable.xcstrings
```

**示例：**
```bash
sed -n '4572,4592p' /Users/chii_magnus/Github_OpenSource/SyncNos/Resource/Localizable.xcstrings
```

**输出示例：**
```json
    "Connect Your Notion" : {
      "comment" : "A button label that prompts the user to connect their Notion workspace.",
      "isCommentAutoGenerated" : true
    },
```

**重要：** `comment` 字段提供了翻译上下文，确保翻译准确性。

### 步骤 3：使用 `sed` 添加翻译

使用 `sed -i ''` 命令在字符串定义的 `{` 后插入 `localizations` 块：

```bash
sed -i '' 's/"目标字符串" : {/"目标字符串" : {\
      "localizations" : {\
        "da" : {\
          "stringUnit" : {\
            "state" : "translated",\
            "value" : "丹麦语翻译"\
          }\
        },\
        "de" : {\
          "stringUnit" : {\
            "state" : "translated",\
            "value" : "德语翻译"\
          }\
        },\
        "es" : {\
          "stringUnit" : {\
            "state" : "translated",\
            "value" : "西班牙语翻译"\
          }\
        },\
        "fi" : {\
          "stringUnit" : {\
            "state" : "translated",\
            "value" : "芬兰语翻译"\
          }\
        },\
        "fr" : {\
          "stringUnit" : {\
            "state" : "translated",\
            "value" : "法语翻译"\
          }\
        },\
        "id" : {\
          "stringUnit" : {\
            "state" : "translated",\
            "value" : "印尼语翻译"\
          }\
        },\
        "ja" : {\
          "stringUnit" : {\
            "state" : "translated",\
            "value" : "日语翻译"\
          }\
        },\
        "ko" : {\
          "stringUnit" : {\
            "state" : "translated",\
            "value" : "韩语翻译"\
          }\
        },\
        "nl" : {\
          "stringUnit" : {\
            "state" : "translated",\
            "value" : "荷兰语翻译"\
          }\
        },\
        "pt-BR" : {\
          "stringUnit" : {\
            "state" : "translated",\
            "value" : "巴西葡萄牙语翻译"\
          }\
        },\
        "ru" : {\
          "stringUnit" : {\
            "state" : "translated",\
            "value" : "俄语翻译"\
          }\
        },\
        "sv" : {\
          "stringUnit" : {\
            "state" : "translated",\
            "value" : "瑞典语翻译"\
          }\
        },\
        "th" : {\
          "stringUnit" : {\
            "state" : "translated",\
            "value" : "泰语翻译"\
          }\
        },\
        "vi" : {\
          "stringUnit" : {\
            "state" : "translated",\
            "value" : "越南语翻译"\
          }\
        },\
        "zh-Hans" : {\
          "stringUnit" : {\
            "state" : "translated",\
            "value" : "简体中文翻译"\
          }\
        }\
      },/' /path/to/Resource/Localizable.xcstrings
```

### 步骤 4：验证 JSON 有效性

每次修改后，验证 JSON 文件格式是否正确：

```bash
python3 -m json.tool /path/to/Resource/Localizable.xcstrings > /dev/null 2>&1 && echo "JSON is valid" || echo "JSON is invalid"
```

### 步骤 5：构建项目验证

最终验证，确保项目可以成功构建：

```bash
cd /path/to/SyncNos && xcodebuild -scheme SyncNos -configuration Debug build 2>&1 | tail -20
```

## 特殊字符转义规则

在 `sed` 命令中，某些字符需要转义：

| 原字符 | 转义后 | 说明 |
|-------|-------|------|
| `'` | `'\''` | 单引号 |
| `.` | `\.` | 句点（在正则表达式中） |
| `/` | `\/` | 斜杠 |
| `&` | `\&` | 与号 |
| `[` | `\[` | 方括号 |
| `]` | `\]` | 方括号 |
| `*` | `\*` | 星号 |
| `$` | `\$` | 美元符号 |
| `\` | `\\` | 反斜杠 |

**示例：**

原字符串：`"We'll create secure databases."`

转义后：`"We'\''ll create secure databases\."`

## 格式化参数处理

对于包含格式化参数的字符串（如 `%d`, `%lld`, `%@`），需要特别注意：

### 单参数字符串

原字符串：`"Found %d books"`

翻译时保持参数位置：
- 中文：`"找到 %d 本书"`
- 日语：`"%d冊の本が見つかりました"`

### 多参数字符串

原字符串：`"Syncing highlights: %d/%d"`

需要使用位置参数 `%1$d`, `%2$d`：
- 中文：`"正在同步高亮: %1$d/%2$d"`
- 日语：`"ハイライトを同期中: %1$d/%2$d"`

## 完整示例

### 示例 1：简单字符串

**目标字符串：** `"Active"`

**步骤 1：搜索**
```bash
grep -n '"Active" :' /Users/chii_magnus/Github_OpenSource/SyncNos/Resource/Localizable.xcstrings
```

**步骤 2：查看 comment**
```bash
sed -n '1428,1440p' /Users/chii_magnus/Github_OpenSource/SyncNos/Resource/Localizable.xcstrings
```

**步骤 3：添加翻译**
```bash
sed -i '' 's/"Active" : {/"Active" : {\
      "localizations" : {\
        "da" : {\
          "stringUnit" : {\
            "state" : "translated",\
            "value" : "Aktiv"\
          }\
        },\
        "de" : {\
          "stringUnit" : {\
            "state" : "translated",\
            "value" : "Aktiv"\
          }\
        },\
        "es" : {\
          "stringUnit" : {\
            "state" : "translated",\
            "value" : "Activo"\
          }\
        },\
        "fi" : {\
          "stringUnit" : {\
            "state" : "translated",\
            "value" : "Aktiivinen"\
          }\
        },\
        "fr" : {\
          "stringUnit" : {\
            "state" : "translated",\
            "value" : "Actif"\
          }\
        },\
        "id" : {\
          "stringUnit" : {\
            "state" : "translated",\
            "value" : "Aktif"\
          }\
        },\
        "ja" : {\
          "stringUnit" : {\
            "state" : "translated",\
            "value" : "アクティブ"\
          }\
        },\
        "ko" : {\
          "stringUnit" : {\
            "state" : "translated",\
            "value" : "활성"\
          }\
        },\
        "nl" : {\
          "stringUnit" : {\
            "state" : "translated",\
            "value" : "Actief"\
          }\
        },\
        "pt-BR" : {\
          "stringUnit" : {\
            "state" : "translated",\
            "value" : "Ativo"\
          }\
        },\
        "ru" : {\
          "stringUnit" : {\
            "state" : "translated",\
            "value" : "Активно"\
          }\
        },\
        "sv" : {\
          "stringUnit" : {\
            "state" : "translated",\
            "value" : "Aktiv"\
          }\
        },\
        "th" : {\
          "stringUnit" : {\
            "state" : "translated",\
            "value" : "ใช้งานอยู่"\
          }\
        },\
        "vi" : {\
          "stringUnit" : {\
            "state" : "translated",\
            "value" : "Đang hoạt động"\
          }\
        },\
        "zh-Hans" : {\
          "stringUnit" : {\
            "state" : "translated",\
            "value" : "活跃"\
          }\
        }\
      },/' /Users/chii_magnus/Github_OpenSource/SyncNos/Resource/Localizable.xcstrings
```

### 示例 2：包含特殊字符的字符串

**目标字符串：** `"We'll create secure databases in your Notion workspace."`

**注意：** 需要转义单引号和句点

```bash
sed -i '' 's/"We'\''ll create secure databases in your Notion workspace\." : {/"We'\''ll create secure databases in your Notion workspace." : {\
      "localizations" : {\
        "zh-Hans" : {\
          "stringUnit" : {\
            "state" : "translated",\
            "value" : "我们将在您的 Notion 工作区中创建安全的数据库。"\
          }\
        }\
        ... 其他语言 ...
      },/' /path/to/Localizable.xcstrings
```

### 示例 3：带格式化参数的字符串

**目标字符串：** `"Syncing highlights: %d/%d"`

**注意：** 使用位置参数 `%1$d`, `%2$d`

```bash
sed -i '' '/"Syncing highlights: %d\/%d" : {/,/^    },$/c\
    "Syncing highlights: %d/%d" : {\
      "localizations" : {\
        "zh-Hans" : {\
          "stringUnit" : {\
            "state" : "translated",\
            "value" : "正在同步高亮: %1$d/%2$d"\
          }\
        }\
        ... 其他语言 ...
      }\
    },' /path/to/Localizable.xcstrings
```

## 常见问题

### Q1: 如何处理已有部分翻译的字符串？

如果字符串已有部分翻译，需要使用范围替换：

```bash
sed -i '' '/"字符串" : {/,/^    },$/c\
    "字符串" : {\
      "localizations" : {\
        ... 完整的翻译块 ...
      }\
    },' /path/to/Localizable.xcstrings
```

### Q2: JSON 验证失败怎么办？

1. 检查逗号是否正确（最后一个语言块后不需要逗号）
2. 检查引号是否配对
3. 检查特殊字符是否正确转义
4. 使用 `python3 -m json.tool file.json` 查看详细错误信息

### Q3: 空条目插入翻译后出现多余逗号？

当原始字符串条目只有 `comment` 字段而没有 `localizations` 块时：

**原始结构（空条目）：**
```json
"dedao.error.rateLimited" : {

},
```

使用 sed 插入 `localizations` 块后可能导致结构错误：
```json
"dedao.error.rateLimited" : {
      "localizations" : {
        ...
      },

    },  // ← 多余的闭合括号和逗号
```

**解决方案：**

1. 插入翻译后，检查 JSON 有效性：
```bash
python3 -m json.tool file.json 2>&1 | head -5
```

2. 如果报错 "Illegal trailing comma"，查看报错行号附近的内容：
```bash
sed -n '报错行号-5,报错行号+5p' file.json
```

3. 手动修复多余的逗号或空行：
```bash
# 删除多余的空行和逗号
sed -i '' '问题行号d' file.json
# 或修复逗号
sed -i '' '问题行号s/      },/      }/' file.json
```

**预防措施：** 在步骤 2 中查看字符串上下文时，特别注意空条目（只有 `{}` 或只有 `comment` 字段），插入后需要额外验证。

### Q4: 如何回滚错误的修改？

使用 Git 回滚：
```bash
git checkout -- Resource/Localizable.xcstrings
```

## 翻译质量建议

1. **参考 comment 字段**：确保理解字符串的使用场景
2. **保持一致性**：同一术语在不同地方使用相同的翻译
3. **考虑长度**：某些语言翻译后可能更长，注意 UI 适配
4. **测试验证**：构建并运行应用，检查翻译效果

## 高效批量翻译技巧

### 紧凑格式（推荐用于简单字符串）

对于简单的 UI 字符串，可以使用更紧凑的单行格式，加快翻译速度：

```bash
sed -i '' 's/"Export as JSON" : {/"Export as JSON" : {\
      "localizations" : {\
        "da" : { "stringUnit" : { "state" : "translated", "value" : "Eksportér som JSON" } },\
        "de" : { "stringUnit" : { "state" : "translated", "value" : "Als JSON exportieren" } },\
        "es" : { "stringUnit" : { "state" : "translated", "value" : "Exportar como JSON" } },\
        "fi" : { "stringUnit" : { "state" : "translated", "value" : "Vie JSON-muodossa" } },\
        "fr" : { "stringUnit" : { "state" : "translated", "value" : "Exporter en JSON" } },\
        "id" : { "stringUnit" : { "state" : "translated", "value" : "Ekspor sebagai JSON" } },\
        "ja" : { "stringUnit" : { "state" : "translated", "value" : "JSONとしてエクスポート" } },\
        "ko" : { "stringUnit" : { "state" : "translated", "value" : "JSON으로 내보내기" } },\
        "nl" : { "stringUnit" : { "state" : "translated", "value" : "Exporteren als JSON" } },\
        "pt-BR" : { "stringUnit" : { "state" : "translated", "value" : "Exportar como JSON" } },\
        "ru" : { "stringUnit" : { "state" : "translated", "value" : "Экспорт в JSON" } },\
        "sv" : { "stringUnit" : { "state" : "translated", "value" : "Exportera som JSON" } },\
        "th" : { "stringUnit" : { "state" : "translated", "value" : "ส่งออกเป็น JSON" } },\
        "vi" : { "stringUnit" : { "state" : "translated", "value" : "Xuất dưới dạng JSON" } },\
        "zh-Hans" : { "stringUnit" : { "state" : "translated", "value" : "导出为 JSON" } }\
      }\
/' Resource/Localizable.xcstrings
```

### 批量处理多个字符串

可以在一个命令中链式处理多个字符串（注意用 `&&` 连接）：

```bash
cd /path/to/SyncNos && \
sed -i '' 's/"String1" : {/.../' Resource/Localizable.xcstrings && \
sed -i '' 's/"String2" : {/.../' Resource/Localizable.xcstrings && \
python3 -m json.tool Resource/Localizable.xcstrings > /dev/null 2>&1 && echo "JSON is valid" || echo "JSON is invalid"
```

### 空条目处理（重要）

对于只有 `{}` 的空条目，插入后结尾应使用 `}\` 而不是 `},\`：

```bash
# 空条目示例
"SomeString" : {

},

# 正确的插入格式（注意最后没有逗号）
's/"SomeString" : {/"SomeString" : {\
      "localizations" : {\
        ...\
      }\
/'
```

## 文件路径

- **Localizable.xcstrings**: `/Users/chii_magnus/Github_OpenSource/SyncNos/Resource/Localizable.xcstrings`
- **项目根目录**: `/Users/chii_magnus/Github_OpenSource/SyncNos`

---

*最后更新: 2025年12月28日*
