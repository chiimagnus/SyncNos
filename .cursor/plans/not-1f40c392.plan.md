<!-- 1f40c392-e934-471a-88f1-5604e70d95af 43ee422b-56c8-4959-a515-c2d81169f608 -->
# Notion 高亮/笔记分块方案（1500 字）

### 一句话概述

将 Notion 上传流程从“截断到 1500 字”改为“分块到 ≤1500 字”，高亮以父块 + 子块形式呈现，笔记按兄弟 `bulleted_list_item` 分块，metadata 作为单独 bullet 子块，保持与现有 API 的兼容性和失败降级策略。

### 关键约定

- 单块最大字符数使用 `NotionSyncConfig.maxTextLengthPrimary`（现为 1500）。
- 优先按换行/空白切分，找不到再按字符截取（UTF-8 grapheme 安全）。
- 高亮结构：父块 `numbered_list_item`（首段），子块：高亮续块（`paragraph`）→ 笔记块（多个 `bulleted_list_item`）→ metadata（1 个 `bulleted_list_item`）。
- 保留现有的降级裁剪（`appendChildrenWithRetry` 与 `buildTrimmedBlock`）。

### 变更清单（代码文件）

- `SyncNos/Services/0-NotionAPI/Core/NotionHelperMethods.swift`
  - 新增：`chunkText(_:, chunkSize:)`、`buildHighlightContinuationChildren`、`buildNoteChildren`、`buildMetaAndLinkBulletChild`
  - 修改：`buildParentRichText`、`buildParentAndChildren`、`buildBulletedListItemBlock`（children 组合逻辑）
- `SyncNos/Services/0-NotionAPI/Operations/NotionHighlightOperations.swift`
  - 修改：`updateBlockContent`（替换 children 为新结构）
- `SyncNos/Services/0-NotionAPI/2-GoodLinksSyncToNotion/GoodLinksSyncService.swift`
  - 自动受益：调用 `buildBulletedListItemBlock` 的地方无需改动

### 重要代码示例（新增/替换核心函数，示意）

```swift
// 新：按优先换行再按字符切分
func chunkText(_ text: String, chunkSize: Int = NotionSyncConfig.maxTextLengthPrimary) -> [String] {
    let normalized = text.replacingOccurrences(of: "\r\n", with: "\n")
    var parts: [String] = []
    // 先按段落（双换行）拆分
    let paragraphs = normalized.components(separatedBy: "\n\n").map { $0.trimmingCharacters(in: .whitespacesAndNewlines) }.filter { !$0.isEmpty }
    for p in paragraphs {
        var start = p.startIndex
        while start < p.endIndex {
            let end = p.index(start, offsetBy: chunkSize, limitedBy: p.endIndex) ?? p.endIndex
            parts.append(String(p[start..<end]))
            start = end
        }
    }
    if parts.isEmpty { return [""] }
    return parts
}

// 新：高亮续块 -> paragraph 子块
func buildHighlightContinuationChildren(for highlight: HighlightRow, chunkSize: Int) -> [[String: Any]] {
    let chunks = chunkText(highlight.text, chunkSize: chunkSize)
    guard chunks.count > 1 else { return [] }
    var children: [[String: Any]] = []
    for c in chunks[1...] {
        children.append(["object": "block", "paragraph": ["rich_text": [["text": ["content": c]]]]])
    }
    return children
}

// 新：note 分成多个 bulleted_list_item（兄弟）
func buildNoteChildren(for highlight: HighlightRow, chunkSize: Int) -> [[String: Any]] {
    guard let note = highlight.note?.trimmingCharacters(in: .whitespacesAndNewlines), !note.isEmpty else { return [] }
    let chunks = chunkText(note, chunkSize: chunkSize)
    return chunks.map { chunk in
        ["object": "block", "bulleted_list_item": ["rich_text": [["text": ["content": chunk], "annotations": ["italic": true]]]]
    }
}

// 新：metadata 作为 bulleted_list_item
func buildMetaAndLinkBulletChild(for highlight: HighlightRow, bookId: String) -> [String: Any] {
    var rich: [[String: Any]] = []
    let meta = buildMetadataString(for: highlight)
    if !meta.isEmpty { rich.append(["text": ["content": meta], "annotations": ["italic": true]]) }
    rich.append(["text": ["content": "\n[uuid:\(highlight.uuid)]"], "annotations": ["italic": true]])
    return ["object": "block", "bulleted_list_item": ["rich_text": rich]]
}
```

### 聚合函数修改要点

- `buildParentRichText`：改为返回 `chunkText(text).first`（不再 truncate）。
- `buildParentAndChildren`：
  - parent = 首块 rich_text
  - children = 高亮续块 paragraphs + note 多个 bullets + metadata bullet
- `buildBulletedListItemBlock`：children 改为使用上面生成的 children 数组。

### updateBlockContent 修改要点

- 仍用 `PATCH blocks/{blockId}` 更新父块 rich_text（首块）。
- 用 `replacePageChildren` 将子块整体替换为：高亮续块 paragraphs、note 多个 bullets、metadata bullet。

### 验证步骤

1. 单元测试/本地手工测试：构造超长高亮和超长 note，调用 create/append/update 流程，断言 Notion payload 中没有被截断且按块分离。
2. 集成测试：对 GoodLinks 示例执行一次完整同步，检查 Notion 页面结构顺序与内容完整性。
3. 失败回退：人为制造 Notion append 失败，验证 `appendChildrenWithRetry` 的二分/裁剪逻辑仍可工作。

### 风险与注意

- Notion API 对 payload 整体大小与单条 block 仍有限制，须依赖 `appendChildrenWithRetry` 做最终降级；本方案尽量避免单条过长，但仍保留裁剪策略。
- 字符切分策略若需对 emoji/复杂 Unicode 做更严格的 grapheme 切分可后续增强。

### To-dos（可直接用于实现）

- add-chunk-util: 新增 chunkText 与按块构建通用工具
- highlight-parent-and-continuations: 实现高亮父块+续块子段构建
- note-multi-bullets: 实现 note 多兄弟 bulleted 子块构建
- metadata-bullet-child: 新增 metadata 子块为 bulleted_list_item
- wire-builder: 整合 buildParentAndChildren 与 buildBulletedListItemBlock
- update-ops: 更新 updateBlockContent 替换 children 新结构
- manual-verify: 手工验证超长高亮/笔记渲染与 API 成功

### To-dos

- [ ] 新增 chunkText 与按块构建通用工具
- [ ] 实现高亮父块+续块子段构建
- [ ] 实现 note 多兄弟 bulleted 子块构建
- [ ] 新增 metadata 子块为 bulleted_list_item
- [ ] 整合 buildParentAndChildren 与 buildBulletedListItemBlock
- [ ] 更新 updateBlockContent 替换 children 新结构
- [ ] 手工验证超长高亮/笔记渲染与 API 成功