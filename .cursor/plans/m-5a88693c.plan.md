<!-- 5a88693c-cb24-439f-a7b8-81604b977e4e 84af6ac2-3624-443e-90b1-c989a8eadb95 -->
# 将 SyncNos 完整迁移到 Notion API `2025-09-03`

## 高层目标

- 把 Notion API 版本从 `2022-06-28` 升级到 `2025-09-03`。
- 引入“发现 data_source_id”的流程（GET /v1/databases/:database_id），并把内部持久化和调用全部改为使用 `data_source_id`（严格不做向前兼容）。
- 把所有写入/查询数据库的请求从使用 `database_id` 的路径/请求体迁移到使用 `data_source_id` 的新路径/请求体（在必要时使用 `data_sources/{id}/query` 等）。
- 将持久化的映射（UserDefaults）由保存 `database_id` 切换为保存 `data_source_id`，并提供一次性迁移逻辑（读取旧值执行发现并替换为 data_source_id）。

## 主要修改文件（逐条列出）

- `SyncNos/Services/0-NotionAPI/Core/NotionServiceCore.swift`
  - 更新 `notionVersion` 值为 `"2025-09-03"`。
- `SyncNos/Services/0-NotionAPI/Core/NotionRequestHelper.swift`
  - 确保 `Notion-Version` 请求头使用新的版本。
  - 新增 `getDataSources(forDatabaseId:)` 或 `getPrimaryDataSourceId(forDatabaseId:)` 的 HTTP helper（`GET /v1/databases/{database_id}` 解析 `data_sources` 字段）。
- `SyncNos/Services/0-NotionAPI/Configuration/NotionConfigStore.swift`
  - 把持久化键（`PER_BOOK_DB_ID_` / `PER_SOURCE_DB_ID_` / `PER_PAGE_DB_ID_`）语义迁移为存储 `data_source_id`（改名为 `PER_BOOK_DATA_SOURCE_ID_` 等或文档注释说明）。
  - 增加一次性迁移方法 `migrateDatabaseIdsToDataSourceIds()`（在启动或首次 Notion 操作时调用，安全、幂等）。
- `SyncNos/Services/0-NotionAPI/Operations/NotionDatabaseOperations.swift`
  - 新增 `getDataSources(databaseId:)` helper；把 `databaseExists(databaseId:)` 的实现调整为可用 `database_id`->discover `data_source_id`，并改为查询 `data_sources[0]` 的有效性或调用 `data_sources/{id}/query` 来验证。
  - 创建数据库接口保留（创建新的 database 对象仍使用 `POST /v1/databases`），但在后续引用数据库进行 query/page 创建时，使用发现到的 `data_source_id`。
  - `findDatabasesUnderPage` 保持使用 blocks children enumeration（child_database 对象在 response 中仍可提供 data source 构造，留意新返回 shape）。
- `SyncNos/Services/0-NotionAPI/Operations/NotionQueryOperations.swift`
  - 所有 `POST /v1/databases/{databaseId}/query` 调用迁移为 `POST /v1/data_sources/{dataSourceId}/query`（使用 discovery helper 获取对应 dataSourceId）。
- `SyncNos/Services/0-NotionAPI/Operations/NotionPageOperations.swift`
  - 在构造 `POST /v1/pages` 的 body 时，把 `parent` 从 `{"type":"database_id","database_id": ...}` 改为 `{"type":"data_source_id","data_source_id": ...}`。
  - 在更新/查询页属性时，路径保持 `pages/{id}`，但如果逻辑依赖 database/query，需要先将 databaseId 映射到 dataSourceId。
- `SyncNos/Services/0-NotionAPI/Operations/NotionHighlightOperations.swift`
  - 所有 `pages` 创建请求、placeholders 创建请求需要使用 `data_source_id` 作为 parent。将 `createHighlightItem(...)`、`createPlaceholderItem(...)`、更新逻辑更新为使用 data_source。
- `SyncNos/Services/0-NotionAPI/Core/NotionService.swift`
  - 把外部对 `ensureDatabaseIdForSource` / `ensurePerBookDatabase` 等 API 的语义改为 `ensureDataSourceIdForSource` / `ensurePerBookDataSource`（或保持同名但返回 data_source_id），并更新实现调用链。
- 其他调用点（`Services/0-NotionAPI/1-AppleBooksSyncToNotion/*`、`GoodLinksSyncService.swift` 等）
  - 将所有通过 notionService 传入的 `databaseId` 假定为 data_source_id，或更新代码以接收新命名值（最小改动：把 notionService 的 ensure 返回值语义改为 data_source_id）。

## 关键代码片段（举例，供实现参考）

- 将版本号改为：
```swift
// 8:9:SyncNos/Services/0-NotionAPI/Core/NotionServiceCore.swift
let notionVersion = "2025-09-03"
```

- 新增 discovery helper（伪代码示例）：
```swift
func getPrimaryDataSourceId(for databaseId: String) async throws -> String {
  let data = try await performRequest(path: "databases/\(databaseId)", method: "GET")
  let json = try JSONSerialization.jsonObject(with: data) as? [String:Any]
  let dss = json?["data_sources"] as? [[String:Any]]
  guard let id = dss?.first?["id"] as? String else { throw ... }
  return id
}
```

- 修改创建页面 parent：
```swift
// 旧
"parent": ["type": "database_id", "database_id": databaseId]
// 新
"parent": ["type": "data_source_id", "data_source_id": dataSourceId]
```

- 修改 query 调用：
```swift
// 旧
POST /v1/databases/{databaseId}/query
// 新
POST /v1/data_sources/{dataSourceId}/query
```


## 数据迁移策略

- 不做向后兼容，**但** 提供一次性迁移步骤：

  1. 在 `NotionConfigStore` 增加 `migrateDatabaseIdsToDataSourceIds()`。
  2. 对现有所有存储的 database_id（per-book / per-source / per-page）执行 `GET /v1/databases/{database_id}`，获取 `data_sources[0].id` 并替换为 new key（或覆盖原 key 内容，但明确文档）。
  3. 此函数须是幂等、带超时/错误处理：若发现某个 `database_id` 解析失败（404/410/403），则删除该映射并记录日志，避免卡住首次启动。

## 验证与回归测试

- 手动检查并运行下列功能：
  - Apple Books 单库（single）策略的同步（ensureDatabaseIdForSource → create page/append highlights）
  - Apple Books per-book 策略（create per-book database/data source → create pages）
  - GoodLinks 同步创建/更新页面
- 验证对 long-content（超长文本） 的创建仍然以分块/占位策略安全降级。
- 验证 Notion 请求头 `Notion-Version` 为 `2025-09-03` 并且 discovery 调用返回 `data_sources` 字段。

## 风险与回退

- 高风险点：持久化键迁移及 key 语义变更可能导致原来存在的 local mapping 失效。计划提供 migration，并建议手动备份 `UserDefaults`（或在 app 内提供导出/备份选项）。
- 如果出现无法恢复的问题，回退策略：把 `notionVersion` 恢复为 `2022-06-28` 并还原旧 UserDefaults 映射（需用户手动恢复备份）。

## 实施 TODOs

- update-core-version — 将 NotionServiceCore.notionVersion 更新为 `2025-09-03`。
- add-discovery-helper — 在 `NotionRequestHelper` 添加 `getPrimaryDataSourceId(for:)` / `getDataSources(for:)`。
- migrate-config-store — 更新 `NotionConfigStore` 的持久化键并实现 `migrateDatabaseIdsToDataSourceIds()`。
- migrate-query-endpoints — 把所有 `databases/{id}/query` 改为 `data_sources/{id}/query`（`NotionQueryOperations`）。
- migrate-page-parent — 把 `pages` body 中 parent 的 `database_id` 切换为 `data_source_id`（`NotionHighlightOperations`、`NotionPageOperations`）。
- migrate-highlight-and-db-ops — 更新 `NotionDatabaseOperations`, `NotionHighlightOperations`, `NotionPageOperations` 的实现细节，确保均以 data_source 工作流为主。
- update-service-api — 更新 `NotionService` 的 ensureXxx helper 让外层调用（如 AppleBooks/GoodLinks）获得并保存 data_source_id。
- migration-run-and-verify — 运行一次性迁移，手动/日志验证关键 API 调用。

每个 TODO 会包含对应文件路径与依赖关系，按上面顺序执行。

---

请确认计划或提出修改（仅需确认开始与否，或在必要时调整是否在首次运行时执行自动迁移）。

### To-dos

- [ ] Update NotionServiceCore.notionVersion to "2025-09-03"
- [ ] Add discovery helper in NotionRequestHelper to GET /v1/databases/{database_id} and return data_sources[]
- [ ] Change NotionConfigStore to store data_source_id (per-book/per-source/per-page) and add migration helper
- [ ] Replace all /databases/{id}/query calls with /data_sources/{dataSourceId}/query (NotionQueryOperations)
- [ ] Update page creation bodies to use parent.type=data_source_id and data_source_id field (NotionPageOperations, NotionHighlightOperations)
- [ ] Update NotionDatabaseOperations, NotionHighlightOperations, NotionPageOperations to operate with data_source ids and discovery helper
- [ ] Update NotionService API semantics (ensureDatabaseIdForSource -> ensureDataSourceIdForSource) and propagate changes to callers
- [ ] Run migration, validate sync flows (AppleBooks single/perBook, GoodLinks), and fix regressions